<div class="container-fluid animate-fade-in">
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-4 animate-fade-in"><i class="fas fa-trophy me-2"></i>User Rankings</h3>
        </div>
    </div>

    <!-- User Rank Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card animate-fade-in delay-1">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-warning p-3 me-3 text-white">
                            <i class="fas fa-medal fa-2x"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">Your Current Rank</h4>
                            <p class="text-muted mb-0">Based on your challenge points</p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6 text-center">
                            <div class="display-1 fw-bold text-warning"><%= currentUserRank %></div>
                            <p class="text-muted">Your position out of all users</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column">
                                <div class="mb-3">
                                    <p class="text-muted mb-1">Your Points</p>
                                    <h3 class="mb-0"><%= locals.user.challengePoints || 0 %> <small class="text-muted">pts</small></h3>
                                </div>
                                <div>
                                    <p class="mb-2">Points needed for next rank:</p>
                                    <% 
                                        // Find the user with rank above current user
                                        const nextRankUser = users.find(function(user, index) { 
                                            return index === currentUserRank - 2; 
                                        });
                                        const pointsNeeded = nextRankUser ? nextRankUser.challengePoints - locals.user.challengePoints : 0;
                                    %>
                                    <% if (currentUserRank === 1) { %>
                                        <div class="alert alert-success">
                                            <i class="fas fa-crown me-2"></i> Congratulations! You're at the top rank!
                                        </div>
                                    <% } else if (pointsNeeded > 0) { %>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-warning" role="progressbar" 
                                                style="width: <%= Math.min(100, (locals.user.challengePoints / (locals.user.challengePoints + pointsNeeded)) * 100) %>%" 
                                                aria-valuenow="<%= Math.min(100, (locals.user.challengePoints / (locals.user.challengePoints + pointsNeeded)) * 100) %>" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted">Need <span class="fw-bold text-warning"><%= pointsNeeded %></span> more points</small>
                                            <small class="text-muted">Next rank: #<%= currentUserRank - 1 %></small>
                                        </div>
                                    <% } else { %>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i> Complete more challenges to improve your rank!
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rankings Table -->
    <div class="row">
        <div class="col-12">
            <div class="card animate-fade-in delay-2">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Top Users Leaderboard</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Rank</th>
                                    <th scope="col">User</th>
                                    <th scope="col">User Code</th>
                                    <th scope="col">Points</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% users.forEach((user, index) => { %>
                                    <tr class="<%= user._id.toString() === locals.user._id.toString() ? 'table-warning' : '' %>">
                                        <td>
                                            <% if (index === 0) { %>
                                                <span class="badge rounded-pill bg-warning px-2 py-1">
                                                    <i class="fas fa-crown me-1"></i> 1
                                                </span>
                                            <% } else if (index === 1) { %>
                                                <span class="badge rounded-pill bg-secondary px-2 py-1">
                                                    <i class="fas fa-medal me-1"></i> 2
                                                </span>
                                            <% } else if (index === 2) { %>
                                                <span class="badge rounded-pill bg-danger px-2 py-1">
                                                    <i class="fas fa-medal me-1"></i> 3
                                                </span>
                                            <% } else { %>
                                                <%= index + 1 %>
                                            <% } %>
                                        </td>
                                        <td>
                                            <%= user.name %>
                                            <% if (user._id.toString() === locals.user._id.toString()) { %>
                                                <span class="badge bg-primary ms-2">You</span>
                                            <% } %>
                                        </td>
                                        <td><code><%= user.userCode %></code></td>
                                        <td><strong><%= user.challengePoints || 0 %></strong> pts</td>
                                        <td>
                                            <% if (user.role === 'admin') { %>
                                                <span class="badge rounded-pill bg-danger px-2 py-1">
                                                    <i class="fas fa-user-shield me-1"></i> Admin
                                                </span>
                                            <% } else { %>
                                                <span class="badge rounded-pill bg-success px-2 py-1">
                                                    <i class="fas fa-user me-1"></i> User
                                                </span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
